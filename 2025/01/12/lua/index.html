<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lua重要知识点总结 | 世界观</title><meta name="author" content="世界"><meta name="copyright" content="世界"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="前言本篇文章主讲三个方面：Lua的性质，Lua的基础理论和重要知识点。尝试言简意赅的呈现各个模块的知识点，并且把一些平时开发可能不会注意到的地方呈现出来。 Lua的性质Lua的设计目的Lua是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放，从一开始就把轻量化，可移植性，可嵌入型，可扩展性等作为自己的设计目标，作为胶水语言来辅助像是C，C++这样的主角来更好地完成工作。 特性轻量型非常小">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua重要知识点总结">
<meta property="og:url" content="http://mscworld.top/2025/01/12/lua/index.html">
<meta property="og:site_name" content="世界观">
<meta property="og:description" content="前言本篇文章主讲三个方面：Lua的性质，Lua的基础理论和重要知识点。尝试言简意赅的呈现各个模块的知识点，并且把一些平时开发可能不会注意到的地方呈现出来。 Lua的性质Lua的设计目的Lua是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放，从一开始就把轻量化，可移植性，可嵌入型，可扩展性等作为自己的设计目标，作为胶水语言来辅助像是C，C++这样的主角来更好地完成工作。 特性轻量型非常小">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://mscworld.top/img/earth.png">
<meta property="article:published_time" content="2025-01-12T05:36:40.717Z">
<meta property="article:modified_time" content="2025-01-19T17:10:02.942Z">
<meta property="article:author" content="世界">
<meta property="article:tag" content="Lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://mscworld.top/img/earth.png"><link rel="shortcut icon" href="/img/roxy4.png"><link rel="canonical" href="http://mscworld.top/2025/01/12/lua/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lua重要知识点总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-20 01:10:02'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="/live2d-widget/autoload.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bggbc.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/roxy4.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-light fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-color: rgba(0,0,255,0);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">Lua重要知识点总结</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-light fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lua重要知识点总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-01-12T05:36:40.717Z" title="发表于 2025-01-12 13:36:40">2025-01-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-19T17:10:02.942Z" title="更新于 2025-01-20 01:10:02">2025-01-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Lua/">Lua</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">11.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>40分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章主讲三个方面：Lua的性质，Lua的基础理论和重要知识点。尝试言简意赅的呈现各个模块的知识点，并且把一些平时开发可能不会注意到的地方呈现出来。</p>
<h2 id="Lua的性质"><a href="#Lua的性质" class="headerlink" title="Lua的性质"></a>Lua的性质</h2><h3 id="Lua的设计目的"><a href="#Lua的设计目的" class="headerlink" title="Lua的设计目的"></a>Lua的设计目的</h3><p>Lua是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放，从一开始就把轻量化，可移植性，可嵌入型，可扩展性等作为自己的设计目标，作为胶水语言来辅助像是C，C++这样的主角来更好地完成工作。</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><h4 id="轻量型"><a href="#轻量型" class="headerlink" title="轻量型"></a>轻量型</h4><p>非常小的尺寸，5.1版本的压缩包仅有208KB，解压后也不过是835KB，Lua解释器只有17000多行的C代码，编译后二级制库文件仅有143KB。</p>
<h4 id="可移植性"><a href="#可移植性" class="headerlink" title="可移植性"></a>可移植性</h4><p>使用clean C 编写的解释器，可以在Mac，Unix，Windows等多个平台轻松编译通过。</p>
<h4 id="可嵌入型"><a href="#可嵌入型" class="headerlink" title="可嵌入型"></a>可嵌入型</h4><p>Lua提供非常丰富的API，可以提供宿主程序与Lua脚本之间进行通信和数据交换。</p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li>语法简单，容易上手，学习成本低。在有其他语言基础而完全未接触过Lua的情况下，能在3天内快速上手并投入业务开发。</li>
<li>轻量，占用小。</li>
</ul>
<h3 id="Lua与游戏开发"><a href="#Lua与游戏开发" class="headerlink" title="Lua与游戏开发"></a>Lua与游戏开发</h3><p>对从事游戏开发行业中的人来说，Lua语言可能并不陌生。因为它满足了占中国游戏市场半壁江山的手游的热更需求，且在经历过国内网易，西山居，腾讯等行业头部的公司的使用，形成多个成熟的Lua热更方案后，Lua作为热更新脚本语言已经成为一时的主流。<br>虽然今年随着更多热更方案的兴起，部分人认为Lua相关的热更方案已经过时了，但在一些老的项目以及游戏框架万年不变的换皮公司中，Lua仍旧是不二之选。</p>
<h2 id="Lua的基础理论"><a href="#Lua的基础理论" class="headerlink" title="Lua的基础理论"></a>Lua的基础理论</h2><p>这里不会从数据类型开始一一介绍，而是会着重讲解一些比较重要以及可能会混淆的知识点。</p>
<h3 id="pairs和ipairs"><a href="#pairs和ipairs" class="headerlink" title="pairs和ipairs"></a>pairs和ipairs</h3><p>简单直接的说两者在遍历上的差距在于</p>
<ol>
<li>pairs的遍历顺序是随机的，但是一定会遍历整个表；ipairs遍历是从索引1开头按顺序遍历的，中途索引不能断开，否则终止遍历；</li>
<li>pairs是先按照索引值遍历，然后按照键值对。</li>
</ol>
<p>接下来通过一个例子来说明差异，这个例子包含3个样例。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> orderTable = &#123;</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> keyTable = &#123;</span><br><span class="line">    [<span class="number">0</span>] = <span class="number">0</span>,</span><br><span class="line">    [<span class="number">1</span>] = <span class="number">1</span>,</span><br><span class="line">    [<span class="number">3</span>] = <span class="number">3</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> mixTable = &#123;</span><br><span class="line">    [<span class="number">1</span>] = <span class="number">1</span>,</span><br><span class="line">    [<span class="number">2</span>] = <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    [<span class="number">4</span>] = <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">    [<span class="number">6</span>] = <span class="number">6</span>,</span><br><span class="line">    <span class="literal">nil</span>,</span><br><span class="line">    [<span class="number">8</span>] = <span class="number">8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">printTable</span><span class="params">(t,prefix)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;----------&quot;</span>.. prefix.. <span class="string">&quot;-----------&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;count :&quot;</span>.. #t)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;pairs:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ipairs:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">printTable(orderTable,<span class="string">&quot;orderTable&quot;</span>)</span><br><span class="line">printTable(keyTable,<span class="string">&quot;keyTable&quot;</span>)</span><br><span class="line">printTable(mixTable,<span class="string">&quot;mixTable&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其打印结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">----------orderTable-----------</span></span><br><span class="line">count :<span class="number">3</span></span><br><span class="line"><span class="built_in">pairs</span>:</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="built_in">ipairs</span>:</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="comment">----------keyTable-----------</span></span><br><span class="line">count :<span class="number">1</span></span><br><span class="line"><span class="built_in">pairs</span>:</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="built_in">ipairs</span>:</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="comment">----------mixTable-----------</span></span><br><span class="line">count :<span class="number">2</span></span><br><span class="line"><span class="built_in">pairs</span>:</span><br><span class="line"><span class="number">3</span></span><br><span class="line">hello world</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="built_in">ipairs</span>:</span><br><span class="line"><span class="number">3</span></span><br><span class="line">hello world</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先看第一个样例，orderTable。<br>pairs和ipars遍历结果一致，都是1，2，3。<br>这是因为ipairs满足从索引1开始按顺序遍历的条件，而无论跑多少次，你都可以发现两者的结果永远一致。这时候你可能会有疑问，上面不是说pairs的遍历结果是随机的吗？这个我们放在mixTable的时候一起说。</p>
<p>接下来看第二个样例，keyTable。<br>pairs遍历结果是0,1,3 ，而ipairs遍历结果是1。<br>ipairs遍历结果因为需要从1开始且出现了索引不连续，因此断开了，只打印了1。</p>
<p>最后看第三个样例，mixTable。<br>pairs遍历结果是3，hello world，8，4，6，而ipairs遍历结果只有一个3。<br>这里你可能会局的奇怪，按照上面的理论，总成员明明有8个，而pairs出去nil却只打印了5个成员，而ipars按照顺序明明看起来有3个，却只打印出了一个3,。</p>
<p>结合上面的的共同点，可以发现 mixTable前面的两个元素：[1] &#x3D; 1 和 [2] &#x3D; 2 通过这两种方式都没有被打印出来。这又是为什么呢？</p>
<p>我们先拆分一下mixTable里面的组成：<br>显式键值对形式部分： {<br>    [1] &#x3D; 1,<br>    [2] &#x3D; 2,<br>    [4] &#x3D; 4,<br>    [6] &#x3D; 6,<br>    [8] &#x3D; 8,<br>}<br>隐式形式部分：{<br>    3,<br>    “hello world”,<br>    nil,<br>}</p>
<p>再把后者中的元素替换前者中对应冲突的键值对<br>首先，后者中的元素形式可以表现为：<br>{<br>    [1] &#x3D; 3,<br>    [2] &#x3D; “hello world”,<br>    [3] &#x3D; nil<br>}</p>
<p>此时可以明显发现冲突，前者中已有的键值对 [1] 和 [2] 与数组中的冲突了，因此需要进行重新匹配，把前者中的替换为后者中的，最终表的形式可以表示为：<br>{<br>    [1] &#x3D; 3,<br>    [2] &#x3D; “hello world”,<br>    [3] &#x3D; nil,<br>    [4] &#x3D; 4,<br>    [6] &#x3D; 6,<br>    [8] &#x3D; 8,<br>}<br>这才是真正遍历的表。再通过初步的理论，推导出结果并对比遍历的结果，便不难理解了。</p>
<p>最后再来说一下pairs的“随机性”，出现这个问题的原因是因为对于lua中的表来说，其遍历标的次序取决于key的hash值，而lua中很多数据类型的哈希值都是随机的。</p>
<p>如果有需要可以重写pairs迭代器，实现顺序遍历。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pairsByKeys</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> sorted = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">        sorted[#sorted + <span class="number">1</span>] = k</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(sorted)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">local</span> v = t[sorted[i]]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> v <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> sorted[i], t[sorted[i]]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _,v <span class="keyword">in</span> pairsByKeys(mixTable) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">3</span></span><br><span class="line">hello world</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意这里本质上是根据key值进行排序，并不是按照表中定义的顺序，无法处理key值无法对比排序的情况，更无法解决冲突的问题，且效率较低。</p>
<h3 id="loadfile-dofile-require"><a href="#loadfile-dofile-require" class="headerlink" title="loadfile,dofile,require"></a>loadfile,dofile,require</h3><ul>
<li>loadfile ——只编译，不运行。loadfile只会加载对应路径的文件，编译其代码，但是不会运行文件里的代码。<br>它会返回一个函数，可以接收后，通过调用并执行里面的代码。</li>
<li>dofile ——编译并运行。dofile会加载对应路径的文件，编译其代码，并运行文件里的代码。</li>
<li>require ——加载并运行，之后进行缓存。缓存之后再次require同一文件不会再执行。</li>
</ul>
<h3 id="rawset和rawget"><a href="#rawset和rawget" class="headerlink" title="rawset和rawget"></a>rawset和rawget</h3><p>顾名思义，raw表示原始的，则rawset和rawget表示对“原始的”表进行直接的赋值&#x2F;取值操作,不会触发元方法。<br>也就是，通过rawset和rawget可以忽略表对应的metatable,绕过元表的行为约束，强制对原始的表进行操作，不需要考虑元表的简单更新。</p>
<p>格式：<br>rawset(table, key, value) ， 它会绕过 __newindex元方法。<br>rawget(table, key) , 它会绕过__index元方法。</p>
<p>应用：<br>一个典型的应用，在__newindex中通过rawset对表进行赋值，可以避免陷入死循环而爆栈。</p>
<h3 id="pcall-xpcall-debug"><a href="#pcall-xpcall-debug" class="headerlink" title="pcall,xpcall,debug"></a>pcall,xpcall,debug</h3><h4 id="pcall"><a href="#pcall" class="headerlink" title="pcall"></a>pcall</h4><p>Lua中处理错误，可以使用pcall(protected call)来包装需要执行的代码。<br>类似于C#里面的try-catch提供一种保护机制，当pcall执行的内容发生错误的时候，会返回false，成功时返回true，通过这种形式可以用来捕获函数执行中的任何错误。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> result , errorMsg = <span class="built_in">pcall</span>(functionName, arg1, arg2,...)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 错误处理</span></span><br><span class="line">    <span class="built_in">print</span>(errorMsg)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里的errorMsg就是发生的错误信息，它会简单显示问题发生的原因。</p>
<h4 id="xpcall与debug"><a href="#xpcall与debug" class="headerlink" title="xpcall与debug"></a>xpcall与debug</h4><p>通常在错误发生时，希望落得更多的调试信息，而不只是发生错误的位置。但pcall返回时，它已经销毁了调用桟的部分内容。这种时候就可以使用xpcall函数。<br>xpcall接收第二个参数——一个错误处理函数，当错误发生时，Lua会在调用桟展开前调用错误处理函数。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myErrorHandler</span><span class="params">(err)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Error: &quot;</span>.. err)</span><br><span class="line">    <span class="comment">--或者</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result = <span class="built_in">xpcall</span>(myFunction, myErrorHandler，arg1, arg2,...)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过这种形式，我们能供直接使用自定义的方法处理错误信息。此时，我们还可以在此自定义方法中使用debug库来获取错误的调用栈等额外信息。<br>debug库提供了两个通用处错误处理函数：</p>
<ul>
<li>debug.debug：提供一个Lua提示符，让用户来检查错误的原因</li>
<li>debug.traceback：根据调用桟来构建一个扩展的错误消息</li>
</ul>
<h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>在 Lua 中，assert 函数用于检查一个条件是否为真。如果条件为真，assert 会继续执行后续代码；如果条件为假，assert 会抛出一个错误并终止程序执行。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert</span>(condition, message)</span><br></pre></td></tr></table></figure>
<p>message 是可选参数，用于自定义错误信息，如果返回为false，则会抛出这个错误信息，默认为：”assertion failed!”。</p>
<p>应用：</p>
<ul>
<li>输入验证：在函数开始时，验证输入参数是否符合预期。</li>
<li>调试：在开发过程中，验证某些假设条件是否成立。</li>
<li>错误处理：在某些关键步骤中，确保条件满足，否则立即终止程序。</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">divide</span><span class="params">(a, b)</span></span></span><br><span class="line">    <span class="built_in">assert</span>(b ~= <span class="number">0</span>, <span class="string">&quot;除数不能为 0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> a / b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(divide(<span class="number">10</span>, <span class="number">2</span>)) <span class="comment">-- 5.0</span></span><br><span class="line"><span class="built_in">print</span>(divide(<span class="number">10</span>, <span class="number">0</span>)) <span class="comment">-- 报错，除数不能为0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="os-time与os-date"><a href="#os-time与os-date" class="headerlink" title="os.time与os.date"></a>os.time与os.date</h3><p>Lua标准库中提供了关于时间的两个方法os.time()与os.date()。</p>
<h4 id="os-time"><a href="#os-time" class="headerlink" title="os.time()"></a>os.time()</h4><p>os.time()方法可以把一个日期字符串转换为时间戳，它返回一个整数，表示从1970年1月1日8点0分0秒到指定日期的秒数（又名 Unix时间戳）。</p>
<ol>
<li>如果传参为空，则返回当前时间转化为秒数的结果。</li>
<li>传参不为空，可以传入指定的时间，将其转化为秒数。传参格式为table，如果传参的话至少要传入年月日才能确定一个具体的时间。如果小于上述指定时间，则秒数为负数，会得到空值。</li>
</ol>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> timeTable = &#123;</span><br><span class="line">    year = <span class="number">2025</span>,</span><br><span class="line">    month = <span class="number">1</span>,</span><br><span class="line">    day = <span class="number">12</span>,</span><br><span class="line">    hour = <span class="number">21</span>,</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">36</span>,</span><br><span class="line">    sec == <span class="number">0</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>(timeTable))  <span class="comment">--1736717760</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意键值不能写错，必须是year，month，day，hour，min，sec。</p>
<h4 id="os-date"><a href="#os-date" class="headerlink" title="os.date()"></a>os.date()</h4><p>os.date()方法可以把一个时间戳（Unix时间戳）转换为固定格式的时间，它返回一个字符串，表示指定时间的日期和时间。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> timeTable = &#123;</span><br><span class="line">    year = <span class="number">2025</span>,</span><br><span class="line">    month = <span class="number">1</span>,</span><br><span class="line">    day = <span class="number">12</span>,</span><br><span class="line">    hour = <span class="number">21</span>,</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">36</span>,</span><br><span class="line">    sec == <span class="number">0</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> unixTime = <span class="built_in">os</span>.<span class="built_in">time</span>(timeTable)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回指定Unix时间戳转化为表形式的内容</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dump</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;*t&quot;</span>, unixTime)))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- result:</span></span><br><span class="line"><span class="comment">--  &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--     &quot;day&quot;   = 12      --日</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;hour&quot;  = 21     --小时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;isdst&quot; = false     --是否夏令时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;min&quot;   = 36     --分钟</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;month&quot; = 1     --月</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;sec&quot;   = 0     --秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;wday&quot;  = 1     --星期几(从周一开始计数1-7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;yday&quot;  = 12     --当年已过天数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--      &quot;year&quot;  = 2025  --年</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--  &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回当前Unix时间戳转化为表形式的内容，格式同上</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dump</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;*t&quot;</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回指定格式的时间字符串</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;%Y-%m-%d, %H:%M:%S&quot;</span>,unixTime))   <span class="comment">--2025-01-12, 21:36:00</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此外，要特别注意的是时区问题。<br>一般情况下，如果要联调处理时间功能，往往是服务器端发过来一个时间戳，客户端操作后转化为指定的可读样式。<br>转换之中如果时区不同，则应当进行时区转换。如果有夏令时，则需要额外加上3600秒。</p>
<h3 id="Lua元表"><a href="#Lua元表" class="headerlink" title="Lua元表"></a>Lua元表</h3><p>元表(MetaTable)的主要作用是用于改变表的行为，每个行为有其对应的元方法。通过这些元方法的赋值，可以将两个table的对应行为进行关联。</p>
<h4 id="设置和获取元表"><a href="#设置和获取元表" class="headerlink" title="设置和获取元表"></a>设置和获取元表</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 对指定table设置元表</span></span><br><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">table</span>, metatable)</span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line">myTable = <span class="built_in">setmetatable</span>(&#123;&#125;, metatable)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回指定对象的元表</span></span><br><span class="line"><span class="built_in">getmetatable</span>(<span class="built_in">table</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="index元方法"><a href="#index元方法" class="headerlink" title="__index元方法"></a>__index元方法</h4><p>这是 metatable 最常用的键。也是后面实现面向对象的关键的元方法。<br>当你通过键来访问 table 的时候，如果这个键没有值，那么Lua就会寻找该table的metatable（假定有metatable）中的__index元方法所指向的table或者方法，从而搜寻对应的值。</p>
<p>格式有两种：</p>
<ol>
<li><p>直接赋值一个table：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">myTable = &#123;</span><br><span class="line">    name = <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myMetatable = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = &#123; age = <span class="number">18</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------------设置元表前------------------&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(myTable.name)  <span class="comment">-- &quot;Alice&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myTable.age)   <span class="comment">-- nil</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(myTable, myMetatable)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------------设置元表后------------------&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(myTable.name)  <span class="comment">-- &quot;Alice&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myTable.age)   <span class="comment">-- 18</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这种情况下，如果元表里面的__index指向的是表，而此表还有元表，且实现了__index仍然指向表，则会以此类推查找，直到找到值或者返回nil。</p>
</li>
<li><p>赋值一个函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">myTable = &#123;</span><br><span class="line">    name = <span class="string">&quot;Alice&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myMetatable = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">&quot;age&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">18</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------------设置元表前------------------&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(myTable.name)  <span class="comment">-- &quot;Alice&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myTable.age)   <span class="comment">-- nil</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(myTable, myMetatable)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;----------------设置元表后------------------&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(myTable.name)  <span class="comment">-- &quot;Alice&quot;</span></span><br><span class="line"><span class="built_in">print</span>(myTable.age)   <span class="comment">-- 18</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>Lua 查找一个表元素时的规则，其实就是如下 3 个步骤:</p>
<ol>
<li>在表中查找，如果找到，返回该元素，找不到则继续</li>
<li>判断该表是否有元表，如果没有元表，返回 nil，有元表则继续。</li>
<li>判断元表有没有 __index 方法，如果 __index 方法为 nil，则返回 nil；如果 __index 方法是一个表，则重复 1、2、3；如果 __index 方法是一个函数，则返回该函数的返回值。</li>
</ol>
<h4 id="newindex元方法"><a href="#newindex元方法" class="headerlink" title="__newindex元方法"></a>__newindex元方法</h4><p>当你给 table 中的某个键赋值的时候，如果这个键没有值，那么Lua就会寻找该table的metatable（假定有metatable）中的__newindex元方法所指向的table或者函数，从而设置对应的值。</p>
<p>格式同__index元方法。</p>
<ol>
<li>赋值为table</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mymetatable = &#123;&#125;</span><br><span class="line">mytable = <span class="built_in">setmetatable</span>(&#123;key1 = <span class="string">&quot;value1&quot;</span>&#125;, &#123; <span class="built_in">__newindex</span> = mymetatable &#125;)</span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(mytable.key1)   <span class="comment">-- &quot;value1&quot;</span></span><br><span class="line"></span><br><span class="line">mytable.newkey = <span class="string">&quot;新值2&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mytable.newkey,mymetatable.newkey) <span class="comment">-- nil  新值2</span></span><br><span class="line"></span><br><span class="line">mytable.key1 = <span class="string">&quot;新值1&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mytable.key1,mymetatable.key1)  <span class="comment">-- 新值1  nil</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>赋值为函数</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mytable = <span class="built_in">setmetatable</span>(&#123;key1 = <span class="string">&quot;value1&quot;</span>&#125;, </span><br><span class="line">&#123; <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key, value)</span></span> </span><br><span class="line">    <span class="built_in">rawset</span>(<span class="built_in">table</span>, key, value)</span><br><span class="line"><span class="keyword">end</span> &#125;)</span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(mytable.key1)   <span class="comment">-- &quot;value1&quot;</span></span><br><span class="line"></span><br><span class="line">mytable.newkey = <span class="string">&quot;新值2&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mytable.newkey) <span class="comment">-- 新值2</span></span><br><span class="line"></span><br><span class="line">mytable.key1 = <span class="string">&quot;新值1&quot;</span></span><br><span class="line"><span class="built_in">print</span>(mytable.key1)  <span class="comment">-- 新值1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的赋值不应当直接赋值，而应当使用rawset，上面已经说过，这里不再赘述。</p>
<h4 id="表操作符"><a href="#表操作符" class="headerlink" title="表操作符"></a>表操作符</h4><table>
<thead>
<tr>
<th>元方法</th>
<th>对应的运算符</th>
</tr>
</thead>
<tbody><tr>
<td>__add</td>
<td>+</td>
</tr>
<tr>
<td>__sub</td>
<td>-</td>
</tr>
<tr>
<td>__mul</td>
<td>*</td>
</tr>
<tr>
<td>__div</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>__mod</td>
<td>%</td>
</tr>
<tr>
<td>__unm</td>
<td>-</td>
</tr>
<tr>
<td>__concat</td>
<td>…</td>
</tr>
<tr>
<td>__eq</td>
<td>&#x3D;&#x3D;</td>
</tr>
<tr>
<td>__lt</td>
<td>&lt;</td>
</tr>
<tr>
<td>__le</td>
<td>&lt;&#x3D;</td>
</tr>
</tbody></table>
<h4 id="call元方法"><a href="#call元方法" class="headerlink" title="__call元方法"></a>__call元方法</h4><p>__call 元方法在 Lua 把一个表当作函数调用时，会调用该元方法。支持自定义传参。<br>其赋值就是一个函数。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mytable = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(mytable, &#123; <span class="built_in">__call</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, arg1, arg2,...)</span></span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">table</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> 	<span class="built_in">print</span>(arg1)</span><br><span class="line">	<span class="built_in">print</span>(arg2)</span><br><span class="line">   </span><br><span class="line"><span class="keyword">end</span> &#125;)</span><br><span class="line"></span><br><span class="line">mytable(<span class="number">8</span>,<span class="number">100</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="tostring元方法"><a href="#tostring元方法" class="headerlink" title="_tostring元方法"></a>_tostring元方法</h4><p>__tostring 元方法用于修改表的输出行为。也就是print(table)时，会调用该元方法，其指向一个函数，有着对应的返回值。<br>如果不实现这个元方法的话，默认的输出行为是table的地址。</p>
<p>格式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mytable = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(mytable, &#123; <span class="built_in">__tostring</span> = <span class="function"><span class="keyword">function</span><span class="params">(table)</span></span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">table</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;mytable&quot;</span></span><br><span class="line"><span class="keyword">end</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mytable)  <span class="comment">-- 1, 2, 3, mytable</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h3 id="Lua实现面向对象"><a href="#Lua实现面向对象" class="headerlink" title="Lua实现面向对象"></a>Lua实现面向对象</h3><p>众所周知面向对象的三大特性，继承，多态，封装。</p>
<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h4><p>继承的实现主要是通过元表的__index元方法来实现。因为继承里面一个很重要的性质就是派生类可以直接使用基类里面的方法和属性，从而减少代码的复用。</p>
<p>单继承</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基类Base</span></span><br><span class="line">Animal = &#123;</span><br><span class="line">    name = <span class="string">&quot;动物&quot;</span>,</span><br><span class="line">    Eat = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;正在吃东西&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line"></span><br><span class="line">    New = <span class="function"><span class="keyword">function</span><span class="params">(self, o, name)</span></span></span><br><span class="line">        o = o <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(o, <span class="built_in">self</span>)</span><br><span class="line">        <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">        name = name <span class="keyword">or</span> <span class="string">&quot;动物&quot;</span></span><br><span class="line">        <span class="built_in">self</span>.name = name</span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">-- 动物对象</span></span><br><span class="line"><span class="keyword">local</span> animal = Animal:New()</span><br><span class="line">animal:Eat()  <span class="comment">-- 动物正在吃东西</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 派生类Cat</span></span><br><span class="line">Cat = Animal:New()</span><br><span class="line"><span class="comment">-- 猫的对象</span></span><br><span class="line"><span class="keyword">local</span> banzai = Cat:New(<span class="literal">nil</span>,<span class="string">&quot;板载&quot;</span>)</span><br><span class="line">banzai:Eat()  <span class="comment">-- 板载正在吃东西</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 派生类Dog</span></span><br><span class="line">Dog = Animal:New(<span class="literal">nil</span>, <span class="string">&quot;狗&quot;</span>)</span><br><span class="line">Dog.hobby = <span class="string">&quot;没有爱好&quot;</span></span><br><span class="line">Dog.New = <span class="function"><span class="keyword">function</span><span class="params">(self, o, name, hobby)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> Animal:New(o, name)</span><br><span class="line">    <span class="built_in">setmetatable</span>(o, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">    name = name <span class="keyword">or</span> <span class="string">&quot;狗&quot;</span></span><br><span class="line">    hobby = hobby <span class="keyword">or</span> <span class="string">&quot;没有爱好&quot;</span></span><br><span class="line">    <span class="built_in">self</span>.hobby = hobby</span><br><span class="line">    <span class="built_in">self</span>.name = name</span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dog.LookingForOutdoors = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;正在期待户外活动&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Dog.ShowHobby = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;的爱好是&quot;</span>..<span class="built_in">self</span>.hobby)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 狗的对象</span></span><br><span class="line"><span class="keyword">local</span> wangcai = Dog:New(<span class="literal">nil</span>, <span class="string">&quot;旺财&quot;</span>)</span><br><span class="line">wangcai:Eat()  <span class="comment">-- 旺财正在吃东西</span></span><br><span class="line">wangcai:LookingForOutdoors()  <span class="comment">-- 旺财正在期待户外活动</span></span><br><span class="line">wangcai:ShowHobby()  <span class="comment">-- 旺财的爱好是散步</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Dog的派生类哈士奇</span></span><br><span class="line">Husky = Dog:New(<span class="literal">nil</span>, <span class="string">&quot;哈士奇&quot;</span>)</span><br><span class="line">Husky.StartToDestroyHouse = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;已经迫不及待开始破坏了&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> husky = Husky:New(<span class="literal">nil</span>, <span class="string">&quot;小哈士奇&quot;</span>,<span class="string">&quot;拆家&quot;</span>)</span><br><span class="line">husky:Eat()  <span class="comment">-- 小哈士奇正在吃东西</span></span><br><span class="line">husky:LookingForOutdoors()  <span class="comment">-- 小哈士奇正在期待户外活动</span></span><br><span class="line">husky:ShowHobby()  <span class="comment">-- 小哈士奇的爱好是拆家</span></span><br><span class="line">husky:StartToDestroyHouse()  <span class="comment">-- 小哈士奇已经迫不及待开始破坏了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--报错示范</span></span><br><span class="line">Cat:ShowHobby()  <span class="comment">-- attempt to call a nil value (method &#x27;ShowHobby&#x27;)</span></span><br><span class="line"></span><br><span class="line">wangcai:StartToDestroyHouse()  <span class="comment">-- attempt to call a nil value (method &#x27;StartToDestroyHouse&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>多继承<br>不错，Lua是可以实现多继承的。在类的基础上实现多继承的方式中__index指向的就不再是单一的table了，而是一个函数。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- 基类Base 动物</span></span><br><span class="line">Animal = &#123;</span><br><span class="line">    name = <span class="string">&quot;动物&quot;</span>,</span><br><span class="line">    Eat = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;正在吃东西&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line"></span><br><span class="line">    New = <span class="function"><span class="keyword">function</span><span class="params">(self, o, name)</span></span></span><br><span class="line">        o = o <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(o, <span class="built_in">self</span>)</span><br><span class="line">        <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">        name = name <span class="keyword">or</span> <span class="string">&quot;动物&quot;</span></span><br><span class="line">        <span class="built_in">self</span>.name = name</span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 基类Base 四足动物</span></span><br><span class="line">Quadruped = &#123;</span><br><span class="line">    Declare = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">self</span>.name .. <span class="string">&quot;有四条腿&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 动物对象</span></span><br><span class="line">Cat = Animal:New()</span><br><span class="line">Cat.Bases = &#123;Animal,Quadruped&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(Cat, &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(<span class="built_in">table</span>.Bases) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> v[key] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> v[key]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> banzai = Cat:New(<span class="literal">nil</span>,<span class="string">&quot;板载&quot;</span>)</span><br><span class="line">banzai:Eat()  <span class="comment">-- 板载正在吃东西</span></span><br><span class="line">banzai:Declare()  <span class="comment">-- 板载有四条腿</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Lua重要知识点"><a href="#Lua重要知识点" class="headerlink" title="Lua重要知识点"></a>Lua重要知识点</h2><p>这个部分的每个知识点都能拓展很多，这里挑一些要点简要说明，把一些以重要且易混淆的地方呈现出来，对此更深层的实现原理和进一步的拓展感兴趣的可以在参考文档中找到对应的模块自行查阅。</p>
<h3 id="require加载机制"><a href="#require加载机制" class="headerlink" title="require加载机制"></a>require加载机制</h3><h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><blockquote>
<p>模块类似于一个封装库，从 Lua 5.1 开始，Lua 加入了标准的模块管理机制，可以把一些公用的代码放在一个文件里，以 API 接口的形式在其他地方调用，有利于代码的重用和降低代码耦合度。<br>Lua 的模块是由变量、函数等已知元素组成的 table，因此创建一个模块很简单，就是创建一个 table，然后把需要导出的常量、函数放入其中，最后返回这个 table 就行。</p>
</blockquote>
<p>在实际使用lua的开发中，无论是管理器，功能通用功能类，已经mvc各层都是通过模块的形式去进行封装的。必要时，其他地方可以通过require进行引入。</p>
<h4 id="require加载策略的优化"><a href="#require加载策略的优化" class="headerlink" title="require加载策略的优化"></a>require加载策略的优化</h4><p>lua中require的加载，它本身其实是具有懒加载的特性的，当一个模块被require之后，会缓存到package.loaded里面，它会一直保存在内存中，直到显式地将其从package.loaded里面移除。</p>
<p>这里要引入两个情况 <strong>循环加载</strong> 和 <strong>冗余占用</strong></p>
<ul>
<li><strong>循环引用。在Lua中，模块之间的循环引用是指两个或多个模块相互require，会形成一个闭环。</strong></li>
<li><strong>冗余占用。在Lua中，在声明引入了一个模块后，可能根据功能使用情况，并不会用到这个模块的功能，这就照成了没有必要的消耗。</strong></li>
</ul>
<p><strong>Lua自身的处理机制：</strong><br>针对循环加载，Lua的模块加载机制是可以处理这种情况的。当一个模块处于加载中，尚未加载完成的时候，会设置一个Flag标识符，来表示当前模块尚未加载完成。<br>因此，即使模块A中包含了加载模块B的代码，而模块B中又有加载模块A的代码。当我们加载A时，A会加载模块B，而B中则会开始加载模块A，但此时得到了模块A还没加载完的标识，便不再继续，从而避免了循环引用。<br>而针对冗余占用，有些可能是程序在开发中不规范导致的；而有些则是没有办法，因为有些功能分支本来就是需要应对可能需要用到的情况。</p>
<p>在这样情况下，我们还能进一步进行优化。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---懒加载自定义，我们可以在初始化定义的时候定义一下</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">require</span> = <span class="built_in">require</span> <span class="string">&quot;lazyRequire&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Lua的懒加载模块：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> packLoaded = <span class="built_in">package</span>.<span class="built_in">loaded</span></span><br><span class="line"><span class="comment">---@type function realRequire 定义原始的require</span></span><br><span class="line"><span class="built_in">_G</span>.realRequire = <span class="built_in">_G</span>.<span class="built_in">require</span></span><br><span class="line">                                  </span><br><span class="line"><span class="comment">---@type table 存放懒加载模块，对同一模块的懒加载返回相同表，模块真正加载后移除</span></span><br><span class="line"><span class="keyword">local</span> tableLazyRequire = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">---@type table lazyRequire返回的表共用元表，从懒加载模块取值会触发__index，真正require模块，并从里面获取值</span></span><br><span class="line"><span class="keyword">local</span> lazyMetaTable = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(t, k)</span></span></span><br><span class="line">        <span class="keyword">local</span> moduleName = t.xcModuleName</span><br><span class="line">        <span class="keyword">local</span> realTable = realRequire(moduleName)</span><br><span class="line">        <span class="built_in">setmetatable</span>(t, &#123; <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">            <span class="keyword">local</span> value = realTable[key]</span><br><span class="line">            <span class="keyword">if</span> value ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">table</span>[key] = value</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span> &#125;)</span><br><span class="line">        tableLazyRequire[moduleName] = <span class="literal">nil</span></span><br><span class="line">        t.xcModuleName = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">return</span> realTable[k]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">---lazyRequire 懒加载模块，避免循环引用， 会多一次index</span></span><br><span class="line"><span class="comment">---故意暴露在全局</span></span><br><span class="line"><span class="comment">---@param name string 模块名，同require的参数</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">lazyRequire</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="comment">--首先，会从系统require表取</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">module</span> = packLoaded[name]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">module</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--其次，再从懒加载表取</span></span><br><span class="line">    <span class="built_in">module</span> = tableLazyRequire[name]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">module</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">--最后，如果两者都没有，则会创建新表并放入懒加载表，返回的module便是此表</span></span><br><span class="line">    <span class="built_in">module</span> = <span class="built_in">setmetatable</span>(&#123; xcModuleName = name &#125;, lazyMetaTable)</span><br><span class="line">    tableLazyRequire[name] = <span class="built_in">module</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">_G</span>.lazyRequire = lazyRequire</span><br><span class="line"><span class="keyword">return</span> lazyRequire</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从这里我们看到，加了一层tableLazyRequire来进行缓存，也就是说在初步定义的时候并没有去真正加载，返回的也并不是对应的模块，而是指向对应模块的缓存表；当这个模块的功能真正被使用的时候，再去真正的加载对应的模块，然后置空其在tableLazyRequire里面的缓存。</p>
<p>以此便解决了循环引用和冗余占用的问题。</p>
<h3 id="Lua的浅拷贝与深拷贝"><a href="#Lua的浅拷贝与深拷贝" class="headerlink" title="Lua的浅拷贝与深拷贝"></a>Lua的浅拷贝与深拷贝</h3><h4 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h4><p>浅拷贝发生在直接使用 赋值运算符”&#x3D;”的时候。</p>
<ul>
<li><p>对于基本类型，会直接进行复制，创建出一个新的对象，两者互不影响。这里的基本类型也就是Lua中除了table以外的类型。</p>
</li>
<li><p>对于table类型，则是进行引用，只是增加了一个指针指向已经存在的内存地址，如果原地址内容发生变化，则浅拷贝出来的对象也会发生变化。</p>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> a = <span class="number">1</span> </span><br><span class="line"><span class="keyword">local</span> b = a</span><br><span class="line"><span class="built_in">print</span>(a)  <span class="comment">-- 1</span></span><br><span class="line"><span class="built_in">print</span>(b)  <span class="comment">-- 1</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(a)  <span class="comment">-- 2</span></span><br><span class="line"><span class="built_in">print</span>(b)  <span class="comment">-- 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> str = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">local</span> str2 = str</span><br><span class="line"><span class="built_in">print</span>(str)  <span class="comment">-- hello</span></span><br><span class="line"><span class="built_in">print</span>(str2)  <span class="comment">-- hello</span></span><br><span class="line"></span><br><span class="line">str = <span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="built_in">print</span>(str)  <span class="comment">-- world</span></span><br><span class="line"><span class="built_in">print</span>(str2)  <span class="comment">-- hello</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t1 = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">local</span> t2 = t1</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">PrintTable</span><span class="params">(t,prefix)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-------------&quot;</span>..prefix ..<span class="string">&quot;----------------&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i , v <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">PrintTable(t1,<span class="string">&quot;t1&quot;</span>)  <span class="comment">-- 1,2,3</span></span><br><span class="line">PrintTable(t2,<span class="string">&quot;t2&quot;</span>)  <span class="comment">-- 1,2,3</span></span><br><span class="line"></span><br><span class="line">t1[<span class="number">1</span>] = <span class="number">4</span></span><br><span class="line">PrintTable(t1,<span class="string">&quot;t1&quot;</span>)  <span class="comment">-- 4,2,3</span></span><br><span class="line">PrintTable(t2,<span class="string">&quot;t2&quot;</span>)  <span class="comment">-- 4,2,3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h4><p>深拷贝主要是应用于table类型。它会增加一个新的指针并申请新的内存，把原来table中的所有值拷贝一份到新内存中，并让这个新增的指针指向这个新开的内存，从而实现深拷贝。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DeepCopy</span><span class="params">(object)</span></span></span><br><span class="line">    <span class="keyword">local</span> lookup_table = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_copy</span><span class="params">(object)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(object) ~= <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> object</span><br><span class="line">        <span class="keyword">elseif</span> lookup_table[object] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> lookup_table[object]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> new_table = &#123;&#125;</span><br><span class="line">        lookup_table[object] = new_table</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(object) <span class="keyword">do</span></span><br><span class="line">            new_table[_copy(key)] = _copy(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setmetatable</span>(new_table, <span class="built_in">getmetatable</span>(object))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> _copy(object)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Animal = &#123;</span><br><span class="line">    name = <span class="string">&quot;动物&quot;</span>,</span><br><span class="line">    Eat = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">self</span>.name..<span class="string">&quot;正在吃东西&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line"></span><br><span class="line">    Habit = &#123;</span><br><span class="line">        [<span class="number">1</span>] =<span class="string">&quot;睡觉&quot;</span>,</span><br><span class="line">        [<span class="number">2</span>] =<span class="string">&quot;吃饭&quot;</span>,</span><br><span class="line">        [<span class="number">3</span>] =<span class="string">&quot;玩耍&quot;</span></span><br><span class="line">    &#125;,  </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> deepCopyAnimal = DeepCopy(Animal)</span><br><span class="line"></span><br><span class="line">Animal.Habit[<span class="number">1</span>] = <span class="string">&quot;新的睡觉&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Animal.Habit[<span class="number">1</span>])  <span class="comment">-- 新的睡觉</span></span><br><span class="line"><span class="built_in">print</span>(deepCopyAnimal.Habit[<span class="number">1</span>])  <span class="comment">-- 睡觉</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="userdata"><a href="#userdata" class="headerlink" title="userdata"></a>userdata</h3><p>full userdata 表示一个原始的内存块，可以存储任何东西，它是一个类似于table的object，必须事先创建（也可以被垃圾收集器回收），它也有自己的metatable，它只等于其自身。</p>
<p>可以为每种full userdata 创建一个唯一的元表，来辨别不同类型的userdata，每当创建了一个userdata后，就用相应的元表（放在Registry中）来标记它，而每得到一个userdata后，就检查它是否拥有正确的元表。</p>
<p>Lua在释放full userdata所关联的内存时，若发现userdata对应的元表还有__gc元方法，则会调用这个方法，并以userdata自身作为参数传入。利用该特性，可以再回收userdata的同时，释放与此userdata相关联的资源。</p>
<p>轻量级userdata是一种表示C指针的值(即void*)，要将一个轻量级userdata放入栈中，只需要调用lua_pushlightuserdata即可。轻量级userdata只是一个指针而已。它没有元表，就像数字一样，轻量级userdata无须受垃圾收集器的管理。</p>
<p>Lua在释放完全userdata所关联的内存时，若发现userdata对应的元表还有__gc元方法，则会调用这个方法，并以userdata自身作为参数传入。利用该特性，可以再回收userdata的同时，释放与此userdata相关联的资源。</p>
<p>它在和其他语言交互时候，起到了很关键的作用，这个到时候可以细讲。</p>
<h3 id="闭包-closure-与upvalue"><a href="#闭包-closure-与upvalue" class="headerlink" title="闭包(closure)与upvalue"></a>闭包(closure)与upvalue</h3><p>闭包(closure)指的是在运行期间，任何时候只要Lua执行了一个function…end表达式，就会创建于一个新的数据对象，这个数据对象，就是闭包。<br>每个闭包由两部分组成，分别是对其函数的引用，对一个元素是对upvalue引用的数组的引用。在5.2版本之前，其实还包含着一个对环境的引用。</p>
<p>其最大的特征在于包含了成员对upvalue引用的数组的引用，如果没有这一点的话，闭包的行为更像是一个普通的函数引用，因为它没有捕获任何额外的局部环境。这也是函数和闭包的区别，有时候我们获取或者定义函数的时候，如果其包含了对upvalue的引用则严格意义上讲，它表示的其实不是函数，而是闭包。要说明这一点首先要说一下Lua函数的性质。</p>
<h4 id="Lua函数的性质"><a href="#Lua函数的性质" class="headerlink" title="Lua函数的性质"></a>Lua函数的性质</h4><p>函数其实是算作第一类型值(First-Class Value)，这种类型具有特定的词法作用域(Lexical Scoping)。前者意味着函数能像数组，字符串，表那样被操作(传参，赋值，运行时创建)，而我们讨论函数的时候，实际上讨论的是指向对应函数的变量。后者则表示函数在其定义的时候可以访问其定义时所在环境中的变量，这种作用域是静态的，即在编译时确定，而不是运行时，这使得函数能够记住其特定的上下文，包括局部变量。<br>这也说明了，函数其实是编译时期的概念，是静态的；而闭包是运行时的概念，是动态的。</p>
<h4 id="Upvalue"><a href="#Upvalue" class="headerlink" title="Upvalue"></a>Upvalue</h4><p>闭包中，对于任何外层局部变量的存取都是间接通过upvalue来进行。upvalue最初指向栈中变量活跃的地方，当其离开变量作用域(超过变量生存期)的时候，此变量会被复制到upvalue中。注意，这里的“复制”指的是upvalue的指针会指向对应的变量。</p>
<p>通过为每个变量创建一个upValue并按照需要重复利用这个upvalue，保证了未决状态（未超过生命周期）的局部变量都能够在闭包之前正确地共享，没错，这里说的是共享。</p>
<p>结构上，Lua会使用并维护一条链表，该链表的每一个节点都会对应一个打开(open)的upvalue，这里的打开指的是当前正指向栈局部变量的upvalue。</p>
<p>流程中，当Lua创建一个新的闭包，Lua会遍历当前函数所有的外部局部变量，对于每一个外部的局部变量，若在上面的链表中能找到该变量，则会重复使用对应打开的upvalue，这也是能共享的原因；如果不能找到，则会创建一个新的打开的upvalue，并把它插入链表中。当局部变量离开作用域的时候，这个的upvalue就会变成关闭状态(closed upvalue)，并会被移除链表，此时闭包中对应的数组还是引用着对应的upvalue的，这也是离开作用域后，我们任然能获取的原因。一旦某个关闭的upvalue不再被任何闭包引用，那么它的存储空间就会被回收。</p>
<img src="/img/lua_closure.png" class="post-image" />

<h4 id="特殊情况"><a href="#特殊情况" class="headerlink" title="特殊情况"></a>特殊情况</h4><p>一个函数可能存取其更外层函数而非直接外层函数的局部变量。在这种情况下，当创建闭包的时候，这个局部变量便可能不在栈中（离开了作用域），也就是进入了close状态，只收到更外层函数闭包里数组的引用，从而导致无法获取。</p>
<p>Lua使用flat闭包（flat closures）来处理这种情况，其核心思想就是将所有被捕获的外部局部变量都存储在闭包的直接外层函数的闭包中，即使这些变量位于更外层的函数。flat闭包的时候，无论何时一个函数访问一个外部的局部变量并且该变量不再在直接外部函数中，该变量也会进入直接外部函数的闭包中。</p>
<h4 id="简结"><a href="#简结" class="headerlink" title="简结"></a>简结</h4><p>我们可以通过一个例子来说明上面的各种情况：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">(n)</span></span></span><br><span class="line">   <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">      <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">inner1</span><span class="params">()</span></span></span><br><span class="line">         <span class="built_in">print</span>(n)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">inner2</span><span class="params">()</span></span></span><br><span class="line">         n = n + <span class="number">10</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">return</span> inner1,inner2</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> foo</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------------------&quot;</span>)</span><br><span class="line">t = Test(<span class="number">2015</span>)</span><br><span class="line">f1,f2 = t()</span><br><span class="line">f1()        <span class="comment">-- 打印2015</span></span><br><span class="line"></span><br><span class="line">f2()</span><br><span class="line">f1()        <span class="comment">-- 打印2025</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">g1,g2 = t()</span><br><span class="line">g1()        <span class="comment">-- 打印2025</span></span><br><span class="line"></span><br><span class="line">g2()</span><br><span class="line">g1()        <span class="comment">-- 打印2035</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------------------&quot;</span>)</span><br><span class="line">f1()        <span class="comment">-- 打印2035</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-----------------------------------&quot;</span>)</span><br><span class="line">t2 = Test(<span class="number">2001</span>)</span><br><span class="line">w1 , w2 = t2()</span><br><span class="line">w1()        <span class="comment">-- 打印2001</span></span><br><span class="line"></span><br><span class="line">w2()    </span><br><span class="line">w1()        <span class="comment">-- 打印2011</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过这个例子，我们可以发现之前知识点的应用：</p>
<ul>
<li>首先作为第一类型值，函数可以作为参数传递，也可以作为返回值返回。上面的test，foo的返回值都是函数，而foo，inner1，inner2则被当做返回值。</li>
<li>分析 Test 函数结构我们能得知。n作为传参传入Test函数中，foo函数的直接外部变量只有n，而inner1和inner2作为foo函数的内部变量，都没有直接外部变量，但其更外层有一个n，且两个函数中都有对于n的使用。</li>
<li>在执行Test的过程中，Lua链表中会创建并打开一个upvalue，让其指向n，此时此upvalue的状态为open，它最先被Test闭包引用；在执行foo函数中的inner1和inner2时候，这两个闭包在创建时堆栈上无法找到n的踪影，则会以flat闭包的形式来处理这种情况，直接使用闭包foo的upvalue来引用n。而执行 t &#x3D; Test(2015) 之后，t这个闭包已经把n拓展保管好了，之后f1和f2用n的时候，就从外层闭包的upvalue中去找，直到找到对应引用并拷贝到自己的upvalue引用数组中，也正是因为如此，f1,f2,g1,g2所引用的upvalue其实都是指向的同一个变量。</li>
<li>t2 &#x3D; Test(2001)的过程是创建一个新的闭包和原来的t闭包没有关系，因此其执行和结果自然也不相干。</li>
</ul>
<h3 id="table的底层实现"><a href="#table的底层实现" class="headerlink" title="table的底层实现"></a>table的底层实现</h3><p>在上面pairs和ipairs里面提了一嘴，Lua中table的存储主要是由两部分组成，数组和哈希表，对于数组的下表是从1开始；而对于哈希表而言，只要非整数键和超过数组范围n的整数键对应的值将被存入哈希表部分。</p>
<h4 id="查找算法的实现"><a href="#查找算法的实现" class="headerlink" title="查找算法的实现"></a>查找算法的实现</h4><p>当我们往table中传入key值，尝试获取其值的时候，就会触发其查找流程。<br>如果当前key为整数且key大于等于0且小于等于数组的大小，则会首先从数组部分进行查找，否则就会从哈希表部分进行查找。后者会计算出该key值的哈希值，然后遍历哈希表找到对应的值。</p>
<p>举个简单的例子：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125;,</span><br><span class="line">t[<span class="number">1</span>] = <span class="number">10</span>,</span><br><span class="line">t[<span class="number">100</span>] = <span class="number">0</span>,</span><br></pre></td></tr></table></figure>
<p>根据上面的规则，我们可以清楚明白的确定，key为1是从数组里面进行查找，key为100则是从哈希表中查找（因为1小于数组的大小，100明显大于数组的大小）。</p>
<h4 id="新增元素的实现原理"><a href="#新增元素的实现原理" class="headerlink" title="新增元素的实现原理"></a>新增元素的实现原理</h4><p>给Lua中添加新元素的时候，对于key值超过数组大小，都会存储于哈希表部分，从而引发哈希表的rehash。<br>rehash过程中，会对table重新规划hash和数组部分的大小。首先会清空数组，然后计算数组部分的大小和范围，再计算哈希表中key的数量和范围，最后进行重新分配。<br>上面过程中两部分值得注意的点是：</p>
<ul>
<li>新的数组部分大小是满足以下条件的最大n值：1到n之间至少一半的空间会被利用，这是为了避免像稀疏数组一样浪费空间。并且n&#x2F;2 + 1到n之间的空间需要至少有一个被利用，这是避免n&#x2F;2个个空间能容纳所有数组的时候申请n个空间造成浪费。</li>
<li>哈希部分则会采用闭散列的算法，它会把有冲突的key存于空闲槽位，从而避免了额外分配内存。</li>
</ul>
<p>举个简单的例子</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125;</span><br><span class="line">t[<span class="number">1</span>] = <span class="number">10</span></span><br><span class="line">t[<span class="number">3</span>] = <span class="number">30</span></span><br><span class="line">t[<span class="number">5</span>] = <span class="number">50</span></span><br><span class="line">t[<span class="number">100</span>] = <span class="number">100</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据上面的规则我们就可以得到其分配情况：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">array_part = &#123;</span><br><span class="line">  [<span class="number">1</span>] = <span class="number">10</span>,</span><br><span class="line">  [<span class="number">2</span>] = <span class="literal">nil</span>,  <span class="comment">-- 可能会有，也可能没有，取决于内部实现</span></span><br><span class="line">  [<span class="number">3</span>] = <span class="number">30</span>,</span><br><span class="line">  [<span class="number">4</span>] = <span class="literal">nil</span>,  <span class="comment">-- 可能会有，也可能没有，取决于内部实现</span></span><br><span class="line">  [<span class="number">5</span>] = <span class="number">50</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hash_part = &#123;</span><br><span class="line">  [<span class="number">100</span>] = <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，还有一个重点，是关于表中隐式key值数组成员，这一点在遍历关键字的内容中已经初步说过了，这里为了方便说明，我们再用一下那个例子：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> mixTable = &#123;</span><br><span class="line">    [<span class="number">1</span>] = <span class="number">1</span>,</span><br><span class="line">    [<span class="number">2</span>] = <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    [<span class="number">4</span>] = <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">    [<span class="number">6</span>] = <span class="number">6</span>,</span><br><span class="line">    <span class="literal">nil</span>,</span><br><span class="line">    [<span class="number">8</span>] = <span class="number">8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面也讲过，此表真正的形式可以表示为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    [<span class="number">1</span>] = <span class="number">3</span>,</span><br><span class="line">    [<span class="number">2</span>] = <span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">    [<span class="number">3</span>] = <span class="literal">nil</span>,</span><br><span class="line">    [<span class="number">4</span>] = <span class="number">4</span>,</span><br><span class="line">    [<span class="number">6</span>] = <span class="number">6</span>,</span><br><span class="line">    [<span class="number">8</span>] = <span class="number">8</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个表根据结构可以得知，它是完全存于数组部分的，没有哈希部分的内容。然而，对于原来的 [1] &#x3D; 1, [2] &#x3D; 2 是和隐式的 3 和 “hello world ” 冲突，受到了替换。这是因为在键值对定义和隐式数组成员的情况下，Lua会优先考虑数组部分的定义，以这种形式来解决掉冲突。</p>
<h4 id="结构设计的优点"><a href="#结构设计的优点" class="headerlink" title="结构设计的优点"></a>结构设计的优点</h4><ol>
<li>存取整数数组部分的键值很快，因为无需计算哈希值。</li>
<li>操作简单，容易上手。无需开发者手动干预，Lua则会自动根据键值特性进行处理。</li>
<li>灵活性强。当表只需要被当做数组使用的时候，它就具备数组的性能，且无需承担哈希表部分的开销，反之亦然。</li>
</ol>
<h3 id="Lua编译器，解释器和虚拟机"><a href="#Lua编译器，解释器和虚拟机" class="headerlink" title="Lua编译器，解释器和虚拟机"></a>Lua编译器，解释器和虚拟机</h3><p>为了达到较高的执行效率，Lua代码并不是直接被Lua解释器解释执行，而是会先编译为字节码，然后再交给Lua虚拟机去执行，这是一个将高级语言转化为低级指令并执行的过程。</p>
<h4 id="Lua编译器"><a href="#Lua编译器" class="headerlink" title="Lua编译器"></a>Lua编译器</h4><p>Lua编译器的主要任务是将Lua源代码(就是纯文本文件)转换为字节码或者某种中间表示形式。编译器再编译的过程中会进行词法分析，语法分析，语义分析等，最终生成可以执行的字节码。这些字节码不是直接由机器执行的机器码，而是由Lua虚拟机解释执行的指令集。</p>
<p>Lua代码称为chunk，编译成的字节码则称为二进制chunk（Binary chunk）。编译器以函数为单位对源代码进行编译，每个函数会被编译成一个称之为原型（Prototype）的结构。</p>
<p>在整个将高级语言转化为低级指令的过程中，目的是使得源代码能够被虚拟机理解和执行。编译器在这里为源代码和虚拟机之间进行连接打开了通道。</p>
<h4 id="Lua解释器"><a href="#Lua解释器" class="headerlink" title="Lua解释器"></a>Lua解释器</h4><p>Lua解释器则负责执行由编译器生成的字节码。解释器会逐条读取字节码，并将其转换为虚拟机可以执行的指令。 解释器与虚拟机紧密配合，确保字节码的正确执行。</p>
<h4 id="Lua虚拟机"><a href="#Lua虚拟机" class="headerlink" title="Lua虚拟机"></a>Lua虚拟机</h4><p>虚拟机相当于物理机，通过借助于操作系统对物理机器（CPU等硬件）的一种模拟、抽象，主要扮演CPU和内存的作用。<br>它主要是是用来执行解释器传递的字节码中的指令，管理全局状态(global_state)、数据栈(StackValue)和函数调用链状态(CallInfo)。<br>当解释器读取并解释字节码时，它会调用虚拟机的指令来执行相应的操作。虚拟机的存在使得Lua代码可以在不同的操作系统和硬件平台上运行，而无需进行大量的修改。</p>
<p>此外，虚拟机可以分为基于寄存器VM（Register Base 和栈VM两种）和栈VM（Stack Base VM）两种。前者包括操作码和操作数，指令只有一条；后者只有操作码，操作数需要从栈里面获取，处理完再压入栈。中。也正是因此，前者可以减少出入栈的数据拷贝操作和生成指令，虽说其单条指令长度较长，但其效率还是相对高些。</p>
<h3 id="gc方式与原理"><a href="#gc方式与原理" class="headerlink" title="gc方式与原理"></a>gc方式与原理</h3><p>gc也就是垃圾回收机制，是指自动释放不再使用的内存，以节省内存开销的过程。GC 的性能表现对整个系统的性能表现影响重大。Go 语言早期就是因为 GC 问题而饱受诟病。如果我们把 GC 关闭，那么 CPU 就完全没有额外开销，但是会有极大的内存开销；如果我们每次分配新对象都运行一遍 GC ，那么就不会有任何额外的内存开销，但是 CPU 开销会完全不可接受。</p>
<p>在 Lua 5.0 以前，Lua 使用的是一个非常简单的标记扫描算法。它从根集开始遍历对象，把能遍历到的对象标记为活对象；然后再遍历通过分配器分配出来的对象全集链表，把没有标记为活对象的其它对象都删除。</p>
<p>而Lua 5.0 支持 userdata ，它可以有 __gc 方法，当 userdata 被回收时，会调用这个方法。所以，一遍标记是不够的，不能简单的把死掉的 userdata 简单剔除，那样就无法正确的调用 __gc 了。所以标记流程需要分两个阶段做，第一阶段把包括 userdata 在内的死对象剔除出去，然后在死对象中找回有 __gc 方法的，对它们再做一次标记复活相关的对象，这样才能保证 userdata 的 __gc 可以正确运行。执行完 __gc 的 userdata 最终会在下一轮 gc 中释放（如果没有在 __gc 中复活）。 userdata 有一个单向标记，标记 __gc 方法是否有运行过，这可以保证 userdata 的 __gc 只会执行一次，即使在 __gc 中复活（重新被根集引用），也不会再次分离出来反复运行 finalizer 。也就是说，运行过 finalizer 的 userdata 就永久变成了一个没有 finalizer 的 userdata 了。<br>针对CPU和内存开销的取舍情况，Lua 5.0 采用的是一个折中的方案：每当内存分配总量超过上次 GC 后的两倍，就跑一遍新的 GC 流程。</p>
<p>从 Lua 5.1 开始，Lua 实现了一个步进式垃圾收集器。这个新的垃圾收集器会在虚拟机的正常指令逻辑间交错分布运行，尽量把每步的执行时间减到合理的范围。<br>而此版本采用了一种叫做三色标记的算法。每个对象都有三个状态：</p>
<ul>
<li>白色。无法被访问到的对象是白色</li>
<li>灰色。可访问到，但没有递归扫描完全的对象</li>
<li>黑色。完全扫描过的对象</li>
</ul>
<p>我们可以假定在任何时间点，下列条件始终成立：</p>
<ol>
<li>所有被根集引用的对象要么是黑色，要么是灰色的。</li>
<li>黑色的对象不可能指向白色的。</li>
<li>白色对象集就是日后会被回收的部分；黑色对象集就是需要保留的部分；灰色对象集是黑色集和白色集的边界。</li>
</ol>
<p>随着收集器的运作，通过充分遍历灰色对象，就可以把它们转变为黑色对象，从而扩大黑色集。一旦所有灰色对象消失，收集过程也就完成了。</p>
<p>步进式 GC 比全量 GC 复杂，不能再只用一个量来控制 GC 的工作时间。对于全量 GC ，我们能调节的是 GC 的发生时机，对于 lua 5.0 ，就是 2 倍上次 GC 后的内存使用量；在 5.1 以后的版本中，这个 2 倍可以由 LUA_GCSETPAUSE 调节。另外增加了 LUA_GCSETSTEPMUL 来控制 GC 推进的速度，默认是 2 ，也就是新增内存速度的两倍。lua 用扫描内存的字节数和清理内存的字节数作为衡量工作进度的标准，有在使用的内存需要标记，没在使用的内存需要清理，GC 一个循环大约就需要处理所有已分配的内存数量的总量的工作。这里 2 是个经验数字，通常可以保证内存清理流程可以跑的比新增要快。</p>
<p>在Lua5.2中，曾经引入分代gc，以一个试验特性提供，后来因为没有收到太多正面反馈，又在Lua5.3中移除。事实上Lua5.2提供的分代GC过于简单，的确有设计问题，未能很好的解决问题，在还没有发布的Lua5.4中，分代GC被重新设计实现。</p>
<h3 id="Lua热更新-热重载"><a href="#Lua热更新-热重载" class="headerlink" title="Lua热更新(热重载)"></a>Lua热更新(热重载)</h3><blockquote>
<p>这里的热更新指的是游戏运行中Lua虚拟机启动后，对代码逻辑修改后直接生效，不需重启游戏，常用于开发过程中调试，不是指游戏启动时的版本更新。</p>
</blockquote>
<p>Lua侧热更新的主要用途在本人这里主要是用于方便重写Lua呈逻辑后，不重启编辑器就可以看到效果，方便快速验证代码和确认效果。比如在制作动效，调试功能BUG等相关场景的时候能够提高效率。但在使用中，upvalue的丢失和框架模块引用嵌套层太多需要重新确定引用过于繁琐，也确定了目前这方面的应用目前只能写作一个小工具便捷开发。</p>
<p>回归上面在讲require的时候，我们说到，require加载一个模块(lua文件)后，会存放到package.loaded中，如果再次require这个模块，就会直接从package.loaded中取出，而不会再次冗余加载。<br>package.loaded本身就是一个Table,其主要包含了：</p>
<ul>
<li>_G全局大G表。</li>
<li>默认加载的模块(string,debug,package,io,os,table,math,coroutine)</li>
<li>用户加载的模块。</li>
</ul>
<p>根据这种情况，可以直接得到一个简单暴力的重载方式：将package.loaded中对应的模块删除，然后再require，就能实现模块的初步更新；之后只需要把其他引用了旧模块的地方进行更新，就可以实现一个简单的热更新效果。</p>
<p>这里</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reload_module</span><span class="params">(module_name)</span></span></span><br><span class="line">    <span class="keyword">local</span> old_module = <span class="built_in">_G</span>[module_name]</span><br><span class="line">    <span class="built_in">package</span>.<span class="built_in">loaded</span>[module_name] = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">require</span> (module_name)</span><br><span class="line">    <span class="keyword">local</span> new_module = <span class="built_in">_G</span>[module_name]</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(new_module) <span class="keyword">do</span></span><br><span class="line">        old_module[k] = v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">package</span>.<span class="built_in">loaded</span>[module_name] = old_module</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过上面的写法可以实现初步的跟新，但实际上还需要把对应引用的地方也进行更新才行。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本篇文章就是这样，希望能够对你有所帮助，当然如果你发现有任何错误的地方，欢迎指出。</p>
<p>话说回来，随着游戏行业的发展以及越来越多热更技术的兴起和成熟，Lua仿佛确实越来越过时了，就连 xLua 作者、司内大佬 johnche 也从 Lua 转向 JavaScript&#x2F;TypeScript，开发了新一代热更新框架 PuerTS。而如果不是其历史包袱，IOS平台限制反射等因素，也许Lua热更新方案的使用趋势可能会更糟糕一些。<br>但无论是从一开始质疑和细数lua的“十宗罪”，到Lua热更方案成为一时主流，再到一部分人高呼“Lua已经过时了”。<br>但Lua本身始终也只是发挥着其能发挥的作用的，正如codedump在《Lua的设计与实现》中所说的，Lua专注做一个配角，作为胶水语言来辅助像是C,C++这样的主角来更好地完成工作，当其他语言在功前面攻城拔寨的时候，它在后方完成自己辅助的作用，Lua始终恪守本分地做好自己胶水语言的本职工作，可谓“上善若水，水善万物而不争”。</p>
<p>最后，新年快到了，祝大家新年快乐，工作和学习的同时，也要身体健健康康的。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li>《Lua的设计与实现》 - codedump</li>
<li><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-error-handling.html">Lua教程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.drflower.top/posts/43f53d35/">花卷的Lua知识点整理</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq826364410/article/details/105659241">鹅厂小哥的遍历关键字差异</a></li>
<li><a target="_blank" rel="noopener" href="https://cjjkkk.github.io/ipairs-pairs-in-lua/">CH33的lua中迭代器pairs和ipairs的比较</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/haobaworenle/article/details/70262047">Lua的rawset和rawget浅析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/fightsyj/article/details/85055342">Lua中的浅拷贝和深拷贝</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq826364410/article/details/88672091">Lua中的userdata</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/herenzhiming/articles/6101767.html">Lua中的userdata-何人之名</a></li>
<li><a target="_blank" rel="noopener" href="https://www.codingnow.com/2000/download/The%20Implementation%20of%20Lua5.0.pdf">The Implementation of Lua 5.0</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/MaximusZhou/article/details/44280109">深入理解Lua的闭包</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zblade/p/8819609.html">Lua中table的实现</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/97830462">深入Lua：Table的实现</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2018/10/lua_gc.html">Lua GC 的工作原理——云风</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/600201746">深入Lua虚拟机</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/kk_flying/article/details/138258231">Lua编译器和lua解释器、lua虚拟机的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2008/03/hot_update.html">Lua热更新系统设计要点</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://mscworld.top">世界</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://mscworld.top/2025/01/12/lua/">http://mscworld.top/2025/01/12/lua/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://mscworld.top" target="_blank">世界观</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Lua/">Lua</a></div><div class="post-share"><div class="social-share" data-image="/img/earth.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/chatpay.png" target="_blank"><img class="post-qr-code-img" src="/img/chatpay.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/pay.png" target="_blank"><img class="post-qr-code-img" src="/img/pay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2025/01/01/summary_annual/" title="2024年度总结"><img class="cover" src="/img/to2025.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2024年度总结</div></div></a><a class="next-post pull-right" href="/2025/01/22/xlua/" title="xLua知识点总结"><img class="cover" src="/img/mono.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">xLua知识点总结</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2025/01/22/xlua/" title="xLua知识点总结"><img class="cover" src="/img/mono.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-22</div><div class="title">xLua知识点总结</div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/roxy4.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">世界</div><div class="author-info-description">才疏学浅，泛泛而谈之辈</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/MscWorld"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/MscWorld" target="_blank" title="Github"><i class="fab fa-github" style="color: #81818C;"></i></a><a class="social-icon" href="Google:z2452009691@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #81818C;"></i></a><a class="social-icon" href="/3254805509" target="_blank" title="QQ"><i class="fa-brands fa-qq" style="color: #81818C;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E7%9A%84%E6%80%A7%E8%B4%A8"><span class="toc-number">2.</span> <span class="toc-text">Lua的性质</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="toc-number">2.1.</span> <span class="toc-text">Lua的设计目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">2.2.</span> <span class="toc-text">特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E5%9E%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">轻量型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%80%A7"><span class="toc-number">2.2.2.</span> <span class="toc-text">可移植性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E5%B5%8C%E5%85%A5%E5%9E%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">可嵌入型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">2.3.</span> <span class="toc-text">优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E4%B8%8E%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91"><span class="toc-number">2.4.</span> <span class="toc-text">Lua与游戏开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E7%9A%84%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="toc-number">3.</span> <span class="toc-text">Lua的基础理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pairs%E5%92%8Cipairs"><span class="toc-number">3.1.</span> <span class="toc-text">pairs和ipairs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loadfile-dofile-require"><span class="toc-number">3.2.</span> <span class="toc-text">loadfile,dofile,require</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rawset%E5%92%8Crawget"><span class="toc-number">3.3.</span> <span class="toc-text">rawset和rawget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pcall-xpcall-debug"><span class="toc-number">3.4.</span> <span class="toc-text">pcall,xpcall,debug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pcall"><span class="toc-number">3.4.1.</span> <span class="toc-text">pcall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xpcall%E4%B8%8Edebug"><span class="toc-number">3.4.2.</span> <span class="toc-text">xpcall与debug</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#assert"><span class="toc-number">3.5.</span> <span class="toc-text">assert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#os-time%E4%B8%8Eos-date"><span class="toc-number">3.6.</span> <span class="toc-text">os.time与os.date</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#os-time"><span class="toc-number">3.6.1.</span> <span class="toc-text">os.time()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#os-date"><span class="toc-number">3.6.2.</span> <span class="toc-text">os.date()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E5%85%83%E8%A1%A8"><span class="toc-number">3.7.</span> <span class="toc-text">Lua元表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%92%8C%E8%8E%B7%E5%8F%96%E5%85%83%E8%A1%A8"><span class="toc-number">3.7.1.</span> <span class="toc-text">设置和获取元表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#index%E5%85%83%E6%96%B9%E6%B3%95"><span class="toc-number">3.7.2.</span> <span class="toc-text">__index元方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#newindex%E5%85%83%E6%96%B9%E6%B3%95"><span class="toc-number">3.7.3.</span> <span class="toc-text">__newindex元方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-number">3.7.4.</span> <span class="toc-text">表操作符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call%E5%85%83%E6%96%B9%E6%B3%95"><span class="toc-number">3.7.5.</span> <span class="toc-text">__call元方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tostring%E5%85%83%E6%96%B9%E6%B3%95"><span class="toc-number">3.7.6.</span> <span class="toc-text">_tostring元方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E5%AE%9E%E7%8E%B0%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.8.</span> <span class="toc-text">Lua实现面向对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF"><span class="toc-number">3.8.1.</span> <span class="toc-text">继承</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">Lua重要知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#require%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">require加载机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97"><span class="toc-number">4.1.1.</span> <span class="toc-text">模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#require%E5%8A%A0%E8%BD%BD%E7%AD%96%E7%95%A5%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">4.1.2.</span> <span class="toc-text">require加载策略的优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E7%9A%84%E6%B5%85%E6%8B%B7%E8%B4%9D%E4%B8%8E%E6%B7%B1%E6%8B%B7%E8%B4%9D"><span class="toc-number">4.2.</span> <span class="toc-text">Lua的浅拷贝与深拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%85%E6%8B%B7%E8%B4%9D"><span class="toc-number">4.2.1.</span> <span class="toc-text">浅拷贝</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D"><span class="toc-number">4.2.2.</span> <span class="toc-text">深拷贝</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#userdata"><span class="toc-number">4.3.</span> <span class="toc-text">userdata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85-closure-%E4%B8%8Eupvalue"><span class="toc-number">4.4.</span> <span class="toc-text">闭包(closure)与upvalue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E5%87%BD%E6%95%B0%E7%9A%84%E6%80%A7%E8%B4%A8"><span class="toc-number">4.4.1.</span> <span class="toc-text">Lua函数的性质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Upvalue"><span class="toc-number">4.4.2.</span> <span class="toc-text">Upvalue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">4.4.3.</span> <span class="toc-text">特殊情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E7%BB%93"><span class="toc-number">4.4.4.</span> <span class="toc-text">简结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#table%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.5.</span> <span class="toc-text">table的底层实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.5.1.</span> <span class="toc-text">查找算法的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E5%85%83%E7%B4%A0%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.5.2.</span> <span class="toc-text">新增元素的实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-number">4.5.3.</span> <span class="toc-text">结构设计的优点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%8C%E8%A7%A3%E9%87%8A%E5%99%A8%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.6.</span> <span class="toc-text">Lua编译器，解释器和虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E7%BC%96%E8%AF%91%E5%99%A8"><span class="toc-number">4.6.1.</span> <span class="toc-text">Lua编译器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="toc-number">4.6.2.</span> <span class="toc-text">Lua解释器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.6.3.</span> <span class="toc-text">Lua虚拟机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gc%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.</span> <span class="toc-text">gc方式与原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E7%83%AD%E6%9B%B4%E6%96%B0-%E7%83%AD%E9%87%8D%E8%BD%BD"><span class="toc-number">4.8.</span> <span class="toc-text">Lua热更新(热重载)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.9.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">5.</span> <span class="toc-text">参考文档</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/03/2025_summary/" title="致聚散离合的2025"><img src="/img/to2026.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="致聚散离合的2025"/></a><div class="content"><a class="title" href="/2026/01/03/2025_summary/" title="致聚散离合的2025">致聚散离合的2025</a><time datetime="2026-01-03T08:12:16.487Z" title="发表于 2026-01-03 16:12:16">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/26/ComponentAutoCollector/" title="组件收集工具—ComponentAutoCollector"><img src="/img/reze.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="组件收集工具—ComponentAutoCollector"/></a><div class="content"><a class="title" href="/2025/10/26/ComponentAutoCollector/" title="组件收集工具—ComponentAutoCollector">组件收集工具—ComponentAutoCollector</a><time datetime="2025-10-26T11:16:19.482Z" title="发表于 2025-10-26 19:16:19">2025-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/18/redPointTree/" title="浅谈红点树与分帧"><img src="/img/alice_dance.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="浅谈红点树与分帧"/></a><div class="content"><a class="title" href="/2025/05/18/redPointTree/" title="浅谈红点树与分帧">浅谈红点树与分帧</a><time datetime="2025-05-18T04:45:11.463Z" title="发表于 2025-05-18 12:45:11">2025-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/18/fsm/" title="关于状态机的一些注意点"><img src="/img/cowboy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="关于状态机的一些注意点"/></a><div class="content"><a class="title" href="/2025/05/18/fsm/" title="关于状态机的一些注意点">关于状态机的一些注意点</a><time datetime="2025-05-18T02:51:15.244Z" title="发表于 2025-05-18 10:51:15">2025-05-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/27/objectPool/" title="对象池设计模式"><img src="/img/fireworks_target.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="对象池设计模式"/></a><div class="content"><a class="title" href="/2025/04/27/objectPool/" title="对象池设计模式">对象池设计模式</a><time datetime="2025-04-27T13:17:10.869Z" title="发表于 2025-04-27 21:17:10">2025-04-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2026 By 世界</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>(() => {
  const panguFn = () => {
    if (typeof pangu === 'object') pangu.autoSpacingPage()
    else {
      btf.getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
        .then(() => {
          pangu.autoSpacingPage()
        })
    }
  }

  const panguInit = () => {
    if (true){
      GLOBAL_CONFIG_SITE.isPost && panguFn()
    } else {
      panguFn()
    }
  }

  btf.addGlobalFn('pjaxComplete', panguInit, 'pangu')
  document.addEventListener('DOMContentLoaded', panguInit)
})()</script><div class="js-pjax"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.1.8/css/lightgallery.css"/><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.1.8/lightgallery.min.js"></script><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://mscworld-hexo.hf.space',
      region: 'ap-hangzhou',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://mscworld-hexo.hf.space',
      region: 'ap-hangzhou',
      onCommentLoaded: function () {
        var commentContents = document.getElementsByClassName('tk-content');
        for (var i = 0; i < commentContents.length; i++) {
          var commentItem = commentContents[i];
          var imgEls = commentItem.getElementsByTagName('img');
          if (imgEls.length > 0) {
            for (var j = 0; j < imgEls.length; j++) {
              var imgEl = imgEls[j];
              var aEl = document.createElement('a');
              aEl.setAttribute('class', 'tk-lg-link');
              aEl.setAttribute('href', imgEl.getAttribute('src'));
              aEl.setAttribute('data-src', imgEl.getAttribute('src'));
              aEl.appendChild(imgEl.cloneNode(false));
              imgEl.parentNode.insertBefore(aEl, imgEl.nextSibling);
              imgEl.remove();
            }
            lightGallery(commentItem, {
              selector: '.tk-lg-link',
              share: false
            });
          }
        }
      }
    }, null))
  }



  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/light.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v6.2.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.3.1" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://huggingface.co/" style="margin-inline:5px" data-title="本站采用多线部署，主线路托管于Hugging Face" title=""><img src="https://img.shields.io/badge/Hosted-Hugging Face-brightgreen?style=flat&amp;logo=Hugging Face" alt=""/></a><a class="github-badge" target="_blank" href="https://dashboard.4everland.org/" style="margin-inline:5px" data-title="本站采用多线部署，备用线路托管于4EVERLAND" title=""><img src="https://img.shields.io/badge/Hosted-4EVERLAND-22DDDD?style=flat&amp;logo=IPFS" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>